generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Application {
  id           String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  appKey       String        @unique @map("app_key")
  name         String
  createdAt    DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  appRoles     AppRole[]
  userAppRoles UserAppRole[]

  @@map("applications")
}

model AppRole {
  id             String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  applicationId  String        @map("application_id") @db.Uuid
  roleKey        String        @map("role_key")
  name           String
  createdAt      DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  application    Application   @relation(fields: [applicationId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  userAppRoles   UserAppRole[]

  @@unique([applicationId, roleKey])
  @@map("app_roles")
}

model UserAppRole {
  id             String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String       @map("user_id") @db.Uuid
  applicationId  String       @map("application_id") @db.Uuid
  customerId     String?      @map("customer_id") @db.Uuid
  appRoleId      String       @map("app_role_id") @db.Uuid
  createdAt      DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  appRole        AppRole      @relation(fields: [appRoleId], references: [id], onUpdate: NoAction)
  application    Application  @relation(fields: [applicationId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  customer       Customer?    @relation(fields: [customerId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([userId, applicationId, customerId, appRoleId])
  @@map("user_app_roles")
}

model Customer {
  id           String                    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code         String                    @unique
  name         String
  status       String                    @default("active")
  createdAt    DateTime                  @default(now()) @map("created_at") @db.Timestamptz(6)
  workspaceLinks BiCustomerWorkspace[]
  reportPermissions BiCustomerReportPermission[]
  pageGroups   BiCustomerPageGroup[]
  pageAllowlist BiCustomerPageAllowlist[]
  userAppRoles UserAppRole[]
  memberships  UserCustomerMembership[]
  rlsRules     RlsRule[]

  @@map("customers")
}

model UserCustomerMembership {
  id         String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String         @map("user_id") @db.Uuid
  customerId String         @map("customer_id") @db.Uuid
  role       MembershipRole @default(viewer)
  isActive   Boolean        @default(true) @map("is_active")
  createdAt  DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  customer   Customer       @relation(fields: [customerId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user       User           @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([userId, customerId])
  @@index([customerId], map: "idx_memberships_customer")
  @@index([userId], map: "idx_memberships_user")
  @@map("user_customer_memberships")
}

model User {
  id                   String                    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  entraSub             String                    @unique @map("entra_sub")
  entraOid             String?                   @unique @map("entra_oid") @db.Uuid
  email                String?                   @db.Citext
  displayName          String?                   @map("display_name")
  createdAt            DateTime                  @default(now()) @map("created_at") @db.Timestamptz(6)
  lastLoginAt          DateTime?                 @map("last_login_at") @db.Timestamptz(6)
  status               UserStatus                @default(pending)
  rlsRules             RlsRule[]
  userAppRoles         UserAppRole[]
  memberships          UserCustomerMembership[]
  pageGroups           BiUserPageGroup[]
  pageAllowlist        BiUserPageAllowlist[]
  auditLogsAsActor     AuditLog[]                @relation("audit_actor")

  @@index([email], map: "idx_users_email")
  @@map("users")
}

model AuditLog {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  actorUserId String?  @map("actor_user_id") @db.Uuid
  action      String
  entityType  String   @map("entity_type")
  entityId    String?  @map("entity_id") @db.Uuid
  beforeData  Json?    @map("before_data")
  afterData   Json?    @map("after_data")
  ip          String?
  userAgent   String?  @map("user_agent")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  actor       User?    @relation("audit_actor", fields: [actorUserId], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@index([createdAt], map: "idx_audit_created")
  @@index([entityType, entityId], map: "idx_audit_entity")
  @@index([actorUserId], map: "idx_audit_actor")
  @@map("audit_log")
}

model BiWorkspace {
  id          String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workspaceId String                   @map("workspace_id") @db.Uuid
  workspaceName String?                @map("workspace_name")
  isActive    Boolean                  @default(true) @map("is_active")
  createdAt   DateTime                 @default(now()) @map("created_at") @db.Timestamptz(6)
  reports     BiReport[]
  customerLinks BiCustomerWorkspace[]

  @@unique([workspaceId])
  @@map("bi_workspaces")
}

model BiReport {
  id            String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  workspaceRefId String              @map("workspace_ref_id") @db.Uuid
  reportId      String               @map("report_id") @db.Uuid
  reportName    String?              @map("report_name")
  datasetId     String?              @map("dataset_id") @db.Uuid
  isActive      Boolean              @default(true) @map("is_active")
  createdAt     DateTime             @default(now()) @map("created_at") @db.Timestamptz(6)
  customerPermissions BiCustomerReportPermission[]
  pages         BiReportPage[]
  pageGroups    BiPageGroup[]
  workspace     BiWorkspace          @relation(fields: [workspaceRefId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([workspaceRefId, reportId])
  @@index([workspaceRefId], map: "idx_bi_reports_workspace")
  @@map("bi_reports")
}

model BiCustomerWorkspace {
  id             String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  customerId     String      @map("customer_id") @db.Uuid
  workspaceRefId String      @map("workspace_ref_id") @db.Uuid
  isActive       Boolean     @default(true) @map("is_active")
  createdAt      DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  customer       Customer    @relation(fields: [customerId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  workspace      BiWorkspace @relation(fields: [workspaceRefId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([customerId, workspaceRefId])
  @@index([customerId], map: "idx_bi_cws_customer")
  @@index([workspaceRefId], map: "idx_bi_cws_workspace")
  @@map("bi_customer_workspaces")
}

model BiCustomerReportPermission {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  customerId  String   @map("customer_id") @db.Uuid
  reportRefId String   @map("report_ref_id") @db.Uuid
  canView     Boolean  @default(true) @map("can_view")
  lastCanView Boolean? @map("last_can_view")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  report      BiReport @relation(fields: [reportRefId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([customerId, reportRefId])
  @@index([customerId], map: "idx_bi_crp_customer")
  @@index([reportRefId], map: "idx_bi_crp_report")
  @@map("bi_customer_report_permissions")
}

model BiReportPage {
  id          String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  reportRefId String             @map("report_ref_id") @db.Uuid
  pageName    String             @map("page_name")
  displayName String?            @map("display_name")
  pageOrder   Int                @default(0) @map("page_order")
  isActive    Boolean            @default(true) @map("is_active")
  createdAt   DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  report      BiReport           @relation(fields: [reportRefId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  groupLinks  BiPageGroupPage[]
  customerAllowlist BiCustomerPageAllowlist[]
  userAllowlist BiUserPageAllowlist[]

  @@unique([reportRefId, pageName])
  @@index([reportRefId], map: "idx_bi_report_pages_report")
  @@map("bi_report_pages")
}

model BiPageGroup {
  id          String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  reportRefId String             @map("report_ref_id") @db.Uuid
  name        String
  isActive    Boolean            @default(true) @map("is_active")
  createdAt   DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  report      BiReport           @relation(fields: [reportRefId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  pages       BiPageGroupPage[]
  customerLinks BiCustomerPageGroup[]
  userLinks   BiUserPageGroup[]

  @@index([reportRefId], map: "idx_bi_page_groups_report")
  @@map("bi_page_groups")
}

model BiPageGroupPage {
  groupId String @map("group_id") @db.Uuid
  pageId  String @map("page_id") @db.Uuid
  group   BiPageGroup @relation(fields: [groupId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  page    BiReportPage @relation(fields: [pageId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([groupId, pageId])
  @@index([pageId], map: "idx_bi_page_group_pages_page")
  @@map("bi_page_group_pages")
}

model BiCustomerPageGroup {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  customerId String   @map("customer_id") @db.Uuid
  groupId    String   @map("group_id") @db.Uuid
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  group      BiPageGroup @relation(fields: [groupId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([customerId, groupId])
  @@index([customerId], map: "idx_bi_cpg_customer")
  @@index([groupId], map: "idx_bi_cpg_group")
  @@map("bi_customer_page_groups")
}

model BiUserPageGroup {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  groupId   String   @map("group_id") @db.Uuid
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  group     BiPageGroup @relation(fields: [groupId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([userId, groupId])
  @@index([userId], map: "idx_bi_upg_user")
  @@index([groupId], map: "idx_bi_upg_group")
  @@map("bi_user_page_groups")
}

model BiCustomerPageAllowlist {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  customerId String   @map("customer_id") @db.Uuid
  pageId     String   @map("page_id") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  page       BiReportPage @relation(fields: [pageId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([customerId, pageId])
  @@index([customerId], map: "idx_bi_cpa_customer")
  @@index([pageId], map: "idx_bi_cpa_page")
  @@map("bi_customer_page_allowlist")
}

model BiUserPageAllowlist {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  pageId    String   @map("page_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  page      BiReportPage @relation(fields: [pageId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([userId, pageId])
  @@index([userId], map: "idx_bi_upa_user")
  @@index([pageId], map: "idx_bi_upa_page")
  @@map("bi_user_page_allowlist")
}

model RlsTarget {
  id              String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  datasetId       String            @map("dataset_id") @db.Uuid
  targetKey       String            @unique @map("target_key")
  displayName     String            @map("display_name")
  factTable       String            @map("fact_table")
  factColumn      String            @map("fact_column")
  valueType       RlsValueType      @map("value_type")
  defaultBehavior RlsDefaultBehavior @default(allow) @map("default_behavior")
  status          RlsTargetStatus   @default(draft)
  createdAt       DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  rules           RlsRule[]

  @@index([datasetId], map: "idx_rls_target_dataset")
  @@map("rls_target")
}

model RlsRule {
  id         String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  targetId   String    @map("target_id") @db.Uuid
  customerId String?   @map("customer_id") @db.Uuid
  userId     String?   @map("user_id") @db.Uuid
  op         RlsRuleOp
  valueText  String?   @map("value_text")
  valueInt   Int?      @map("value_int")
  valueUuid  String?   @map("value_uuid") @db.Uuid
  createdAt  DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  target     RlsTarget @relation(fields: [targetId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user       User?     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([targetId], map: "idx_rls_rule_target")
  @@index([customerId], map: "idx_rls_rule_customer")
  @@index([userId], map: "idx_rls_rule_user")
  @@map("rls_rule")
}

enum UserStatus {
  pending
  active
  disabled

  @@map("user_status")
}

enum MembershipRole {
  owner
  admin
  member
  viewer

  @@map("membership_role")
}

enum RlsValueType {
  text
  int
  uuid

  @@map("rls_value_type")
}

enum RlsDefaultBehavior {
  allow
  deny

  @@map("rls_default_behavior")
}

enum RlsTargetStatus {
  draft
  active

  @@map("rls_target_status")
}

enum RlsRuleOp {
  include
  exclude

  @@map("rls_rule_op")
}
